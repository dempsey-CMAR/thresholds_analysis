---
format: 
  html:
    toc: true
    toc-depth: 3
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 600, fig.width = 8)

library(dplyr)
library(DT)
library(here)
library(ggplot2)
library(leaflet)
library(lubridate)
library(plotly)
library(quarto)
library(RColorBrewer)
library(readr)

theme_set(theme_light())

dt_options <- list(
      dom = 'ft',
      paging = FALSE,
      searching = FALSE,
     # scrollY = "500px",
      pageLength = 500,
      columnDefs = list(list(className = 'dt-center', targets = "_all"))
)

# summarized data 
dat <- read_csv(
  here("data/summary_filtered_data.csv"), show_col_types = FALSE
) %>% 
  filter(variable == "Temperature")

gr_thresholds <- read_csv(
  here("data/grossrange_thresholds.csv"), show_col_types = FALSE
)

```

# Thresholds

**DRAFT February 3, 2023**

- Intro text about QARTOD tests.
- Table (with links?) of the tests we are applying
- Table of flag values 
  - [Pass]{style="color: #009200;"}
  - [Not Evaluated]{style="color: #E6E1BC;"}
  - [Suspect/Of Interest]{style="color: #EDA247;"}
  - [Fail]{style="color: #DB4325;"}
  - [Missing Data]{style="color: #5A5A5A;"}
- Need to select thresholds for each test

We based thresholds off historical data.

The historical data used here was the Coastal Monitoring Program Water Quality data sets submitted to the [Nova Scotia Open Data Portal](https://data.novascotia.ca/browse?q=coastal%20monitoring&sortBy=relevance) in December 2022. Preliminary quality control measures (e.g., obvious outliers and suspected biofouling removed) were applied to these datasets before submission. Additionally, freshwater and other outlier stations were excluded from the threshold analysis to provide a better representation of "normal" conditions. 


# Gross Range

The Gross Range Test aims to flag observations that fall outside of the sensor measurement range (flagged [Fail]{style="color: #DB4325;"}) and observations that are statistical outliers (flagged [Suspect/Of Interest]{style="color: #EDA247;"}).

Thresholds for [failed]{style="color: #DB4325;"} observations are determined by the sensor specifications, and were assigned based on information in the associated manuals.

Thresholds for [suspect/of interest]{style="color: #EDA247;"} observations are defined by the user. Following the [OOI Biogeochemical Sensor Data: Best Practices & User Guide](https://docs.google.com/document/d/19pS5V1hsKAcSaGjwfmyrmZRIJFMXNAc4B0Uo9Akvmd4/edit#heading=h.u87btnaapb66), these thresholds were calculated from historical data as the mean +/- three standard deviations (@eq-user-min, @eq-user-max):

$$
user_{min} = avg_{var} - 3 * stdev_{var}  
$$ {#eq-user-min}

$$
user_{max} = avg_{var} + 3 * stdev_{var}
$$ {#eq-user-max}

where $avg_{var}$ is the overall or "gross" average of the variable of interest, and
$stdev_{var}$ is the standard deviation of the variable of interest. 

The historical data used here was the Coastal Monitoring Program Water Quality data sets submitted to the [Nova Scotia Open Data Portal](https://data.novascotia.ca/browse?q=coastal%20monitoring&sortBy=relevance) in December 2022. Preliminary quality control measures (e.g., obvious outliers and suspected biofouling removed) were applied to these datasets before submission. Additionally, freshwater and other outlier stations were excluded from the threshold analysis to provide a better representation of "normal" conditions. 


- exercise should be repeated in a few years.

More detail on how these thresholds were selected for each variable is provided below.


## Temperature

### Sensor threholds

The sensor thresholds were determined based on the associated manual (Table 1).

```{r}
gr_thresholds %>% 
  filter(variable == "temperature_degree_c") %>%
  mutate(
    `Sensor (link to spec sheet)` = 
      paste0('<a  target=_blank href=', url, '>', sensor_type,'</a>') 
  ) %>% 
  select( `Sensor (link to spec sheet)`, sensor_min, sensor_max ) %>% 
  datatable(
    options = dt_options, rownames = FALSE, escape = FALSE,
    caption = "Table 1: Temperature gross range thresholds as determined by sensor specifications."
  )
```

### User thresholds

User thresholds were calculated separately for each county (Table 2).

For most counties, the overall average temperature (all year, depths, stations) was substantially influenced by the number of observations in each month (@fig-temp-n-clim, @fig-temp-avg-comp).

To give each month equal weight regardless of the number of observations collected, the user thresholds were based on the monthly climatology.

All temperature observations were first grouped by calendar month, and the average temperature for each month was calculated. The $avg_{Temp}$ was the average of these monthly values, and $stdev_{Temp}$ was the standard deviation of the monthly values (@eq-temp-avg, @eq-temp-stdev).

$$
avg_{temp} = sum(avg_{Jan} + avg_{Feb} + ... avg_{Dec}) / 12
$$ {#eq-temp-avg}

$$
stdev_{temp} = sd(avg_{Jan}, avg_{Feb}, ... avg_{Dec})
$$ {#eq-temp-stdev}


```{r}
# calculate thresholds based on the climatology
user_thresh <- dat %>% 
  filter(
    group == "county_month", 
    variable == "Temperature"
  ) %>% 
  rename(mean_month = mean) %>% 
  group_by(county) %>%
  summarise(
    mean = round(mean(mean_month), digits = 3),
    stdev = round(sd(mean_month), digits = 3)
  ) %>% 
  mutate(
    qc_test = "grossrange",
    variable = "temperature_degree_c",
    user_min = mean - 3 * stdev, 
    user_max = mean + 3 * stdev
  ) 

user_thresh %>% 
  select(county, user_min, user_max) %>% 
  datatable(
    options = dt_options, rownames = FALSE,
    caption = "Table 2: Temperature user thresholds based on historical data."
  )
```


#### Considerations
The quality[^1] of these user thresholds may vary by county, depending on the number and distribution (in space and time) of observations. For example, there are relatively few observations for some counties compared to others (@fig-temp-n-obs). Cape Breton has the fewest observations at ~30,000 over 3 years and two stations, while Guysborough has the most at nearly 1 million over 7 years and 35 stations. For consistency, the counties with fewer observations were not pooled with counties with more observations, although this may be a future task. Otherwise, the user thresholds for counties with less data should be re-evaluated when more observations are collected.

Calculating thresholds at the county scale provides relatively coarse threshold values. Ideally, these would be resolved by depth and a smaller spatial scale (e.g., waterbody or station). However, calculating thresholds for each county and depth provides its own challenges. For example, the data become very patchy when grouped by county, depth, and month (e.g., 169 month-county-depth combinations with 0 observations). Additionally, the same depth can represent a different part of the water column for different stations. For example, at the Barren Island station in Guysborough county, the 15 m sensor is near the bottom. In contrast, 15 m is in the top 20 % of the water column at Tickle Island, also in Guysborough county. Finally, aggregating thresholds by county and depth would result in 141 user-defined temperature thresholds, which is more than the 2.5 person Data Governance team can reasonably manage.

Because depth was not accounted for, it is expected that observations from very shallow sensors (e.g., <= 2 m) will be assigned the [Suspect/Of Interest]{style="color: #EDA247;"} flag, despite appearing reasonable in the context of the deployment. In this case, the flag should be interpreted as ["Of Interest"]{style="color: #EDA247;"}, for highlighting a relatively warm observation.

The user_min threshold is typically << 0 degrees Celsius (Table 2), and is therefore not expected to flag any observations. For most counties (all except Annapolis, Queens, Shelburne, and Digby), the user_min is less than the sensor_min for the aquameasure and vr2ar sensors. In this case, any observations less than the sensor_min would [fail]{style="color: #DB4325;"} the gross range test (i.e., the user_min would be ignored). It may be useful for other users to apply their own user_min threshold to the data to highlight cold observations that are [Suspect/Of Interest]{style="color: #EDA247;"}. For example, those interested in salmonid aquaculture may wish to flag observations at or near the superchill threshold (user_min = -0.7 degree C).

## Suporting Figures

```{r}
county <- dat %>% 
  filter(group == "county") %>% 
  select(-c(variable, units, year, depth, month, station))

county_month <- dat %>% 
  filter(group == "county_month") %>% 
  mutate(month = month(month, label = TRUE)) %>% 
  select(-c(variable, units, group, year, station, depth))
```

::: panel-tabset

### Figure 1
```{r}
#| label: fig-temp-n-clim
#| fig-height: 12
#| fig-cap: The number of temperature observations in each month for each county.

p <- ggplot(county_month , aes(n, month)) +
  geom_col(
    position = position_dodge2(preserve = "single", reverse = TRUE, padding = 0)
  ) +
  scale_y_discrete(name = "", limits = rev) +
  scale_x_continuous("Number of Temperature Observations") +
  facet_wrap(~ county, ncol = 3) +
  theme(panel.spacing.y = unit(15, "lines"))

ggplotly(p)
```

### Figure 2
```{r}
#| label: fig-temp-avg-comp
#| fig-height: 8
#| fig-cap: The mean and standard deviation of temperature in each county, calculated from all observations and from climatology.

p <- user_thresh %>% 
  mutate(group = "county_climatology") %>% 
  bind_rows(county %>% select(-n)) %>% 
  ggplot(aes(mean, county, fill = group, col = group)) +
  geom_errorbar(
    aes(xmin = mean - stdev, xmax = mean + stdev), 
    width = 0, linewidth = 1, alpha = 0.75
  ) +
  geom_point(size = 3, pch = 21, col = 1) +
  scale_y_discrete(name = "", limits = rev) +
  scale_x_continuous("Temperature (degree C)")

ggplotly(p)
```


### Figure 3
```{r}
#| label: fig-temp-n-obs
#| fig-height: 8
#| fig-cap: The number of temperatures observations in each county. 

p <- ggplot(county, aes(n, county)) +
  geom_col(
    position = position_dodge2(preserve = "single", reverse = TRUE, padding = 0)
  ) +
  scale_y_discrete(name = "", limits = rev) +
  scale_x_continuous("Number of Temperature Observations")

ggplotly(p)
```

:::

```{r, export-thresholds}
thresh_out <- gr_thresholds %>% 
  filter(variable == "temperature_degree_c") %>% 
  select(-url) %>% 
  mutate(county = NA) %>%  
  bind_rows(
    user_thresh %>% 
      select(county, variable, user_min, user_max) %>% 
      mutate(sensor_type = NA)
  ) %>% 
  pivot_longer(
    cols = c("sensor_min", "sensor_max", "user_min", "user_max"),
    names_to = "threshold", values_to = "threshold_value"
  ) %>% 
  filter(!is.na(threshold_value))

write_csv(thresh_out, here("output/temp_grossrange.csv"))

write_csv(
  thresh_out, 
  "C:/Users/Danielle Dempsey/Desktop/RProjects/Packages/qaqcmar/data-raw/temp_grossrange.csv")

```

# Climatology

The Climatology Test is a variation of the Gross Range Test (QARTOD ref here) that accounts for seasonal variability. There is no [Fail]{style="color: #DB4325;"} flag associated with this test for temperature, salinity, or dissolved oxygen due to the dynamic nature of these variables (Temp/Salinity and DO QARTOD manuals). However, observations that are seasonal outliers are assigned the  flag [Suspect/Of Interest]{style="color: #EDA247;"}.

The seasonal time period (e.g., monthly, seasonally, other) and associated thresholds are defined by the user. Following the [OOI Biogeochemical Sensor Data: Best Practices & User Guide](https://docs.google.com/document/d/19pS5V1hsKAcSaGjwfmyrmZRIJFMXNAc4B0Uo9Akvmd4/edit#heading=h.u87btnaapb66), seasons were defined based on the calendar month, and the thresholds were based on historical data.






[^1]: e.g., how representative the thresholds are of "normal" conditions through the water column and county

# References

https://docs.google.com/document/d/19pS5V1hsKAcSaGjwfmyrmZRIJFMXNAc4B0Uo9Akvmd4/edit#

QARTOD docs

`r knitr::knit_exit()`

